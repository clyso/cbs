# CBS - CES Build Service
# Copyright (C) 2025  Clyso GmbH
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.

services:
  worker:
    build: ./cbs
    container_name: clyso-cbs-worker
    entrypoint: uv run --no-sync celery -A cbslib.worker worker --loglevel=info --concurrency=1
    privileged: true
    volumes:
      - ./_local/cbs/cbs-config.worker.json:/cbs/config/cbs-config.json
      - ./cbs:/cbs/tools

      - ./_local/secrets.json:/cbs/secrets/secrets.json
      - ./_local/cbs/scratch:/cbs/scratch
      - ./_local/cbs/scratch/containers:/var/lib/containers
      - ./_local/cbs/scratch/ccache:/cbs/ccache
      - ./components:/cbs/components
      - /dev/fuse:/dev/fuse:rw
    cap_add:
      - MKNOD
      - SYS_ADMIN
    security_opt:
      - label=disable
      - seccomp=unconfined
    environment:
      CBS_CONFIG: /cbs/config/cbs-config.json
      CBS_DEBUG: 1
    network_mode: host
    depends_on:
      - redis

  cbs:
    build: ./cbs
    container_name: clyso-cbs
    ports:
      - "8080:8080"
    restart: "no"
    privileged: true
    volumes:
      - ./_local/cbs/cbs-config.server.json:/cbs/config/cbs-config.json

      - ./_local/cbs/google-client-cbs.json:/cbs/secrets/google-client-cbs.json
      - ./_local/secrets.json:/cbs/secrets/secrets.json
      - ./_local/cbs/data:/cbs/data
      - ./_local/cbs/cbs-cert.pem:/cbs/config/cbs-cert.pem
      - ./_local/cbs/cbs-key.pem:/cbs/config/cbs-key.pem
      - ./cbs:/cbs/tools
    security_opt:
      - label=disable
      - seccomp=unconfined
    environment:
      CBS_CONFIG: /cbs/config/cbs-config.json
      CBS_DEBUG: 1
    depends_on:
      - redis

  flower:
    build: ./cbs
    container_name: clyso-cbs-worker-flower
    entrypoint: uv run --no-sync celery --broker=redis://redis:6379/0 -A cbslib.worker flower
    ports:
      - "5555:5555"
    volumes:
      - ./_local/cbs/cbs-config.server.json:/cbs/config/cbs-config.json
    environment:
      CBS_CONFIG: /cbs/config/cbs-config.json
      CBS_DEBUG: 1
    security_opt:
      - label=disable
    depends_on:
      - worker
      - redis

  redis:
    image: redis:7
    ports:
      - "6379:6379"
