# CBS - CES Build Service
# Copyright (C) 2025  Clyso GmbH
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.

services:
  cbs:
    build:
      context: .
      dockerfile: ./container/ContainerFile.compose
    container_name: clyso-cbs-server
    ports:
      - "8080:8080"
    restart: "no"
    privileged: true
    volumes:
      - ./_local/cbs/config/server:/cbs/config
      - ./_local/cbs/data:/cbs/data
    security_opt:
      - label=disable
      - seccomp=unconfined
    environment:
      CBS_CONFIG: /cbs/config/cbsd.server.config.yaml
      CBS_DEBUG: 1
    depends_on:
      redis:
        condition: service_started
      worker:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: ./container/ContainerFile.compose
    container_name: clyso-cbs-worker
    entrypoint: uv run --no-sync celery -A cbslib.worker worker -E --loglevel=info --concurrency=1
    privileged: true
    volumes:
      - ./_local/cbs/config/worker:/cbs/config
      - ./cbscore:/cbs/src

      - ./_local/cbs/scratch:/cbs/scratch
      - ./_local/cbs/scratch/containers:/var/lib/containers
      - ./_local/cbs/scratch/ccache:/cbs/ccache
      - ./components:/cbs/components
      - /dev/fuse:/dev/fuse:rw
    cap_add:
      - MKNOD
      - SYS_ADMIN
    security_opt:
      - label=disable
      - seccomp=unconfined
    environment:
      CBS_CONFIG: /cbs/config/cbsd.worker.config.yaml
      CBS_DEBUG: 1
    # We require the host network to be able to properly access interfaces
    # such as those of a vpn. This means the cbs worker is not in the same
    # network as the other containers, and must access the redis broker by
    # its external address (in this case, localhost). This must be taken
    # into account when configuring the worker.
    network_mode: host
    healthcheck:
      test:
        ["CMD-SHELL", "uv run --no-sync celery -A cbslib.worker inspect ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
      start_interval: 5s
    depends_on:
      - redis

  redis:
    container_name: cbs-redis
    image: docker.io/redis:7
    ports:
      - "6379:6379"
